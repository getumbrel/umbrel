#!/usr/bin/env bash

set -euo pipefail

UMBREL_ROOT="$(readlink -f $(dirname "${BASH_SOURCE[0]}")/../../..)"
block_device="${1}"
mount_point="${2}"

check_if_not_already_running() {
  if ps ax | grep $0 | grep -v $$ | grep bash | grep -v grep
  then
    echo "storage monitor is already running"
    exit 1
  fi
}

main () {
  check_if_not_already_running

  while true; do
    echo "Checking Umbrel root is bind mounted to external storage..."
    if ! df -h "${UMBREL_ROOT}" | grep --quiet "/dev/${block_device}"; then
      break
    fi

    echo "Checking external storage is mounted..."
    mount_data=$(grep " ${mount_point} " /proc/mounts)
    if [[ "$(echo ${mount_data} | wc -l)" == "0" ]]; then
      break
    fi

    echo "Checking external storage is not mounted as read only..."
    if echo "${mount_data}" | grep --quiet '[ ,]ro[ ,]'; then
      break
    fi

    echo "Checking mounted block device still exists..."
    if ! [[ -e "/dev/${block_device}" ]]; then
      break
    fi

    sleep 1
  done

  echo "Check failed, stopping Umbrel..."
  docker stop $(docker ps -aq)
}

main
