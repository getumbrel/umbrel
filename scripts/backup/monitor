#!/usr/bin/env bash

check_root () {
  if [[ $UID != 0 ]]; then
    echo "Error: This script must be run as root."
    exit 1
  fi
}

check_if_not_already_running() {
  if ps ax | grep $0 | grep -v $$ | grep bash | grep -v grep
  then
    echo "backup monitor is already running"
    exit 1
  fi
}

check_dependencies () {
  for cmd in "$@"; do
    if ! command -v $cmd >/dev/null 2>&1; then
      echo "This script requires \"${cmd}\" to be installed"
      exit 1
    fi
  done
}

check_root

check_if_not_already_running

check_dependencies fswatch readlink dirname

UMBREL_ROOT="$(dirname $(readlink -f "${BASH_SOURCE[0]}"))/../.."

trigger_backup () {
  touch "${UMBREL_ROOT}/events/signals/backup"
}

monitor_path () {
  file_path="${1}"
  echo "Monitoring $file_path..."
  fswatch -0 --event=PlatformSpecific $file_path | xargs -0 -n 1 -I {} trigger_backup
}

if [[ ! -d "${UMBREL_ROOT}" ]]; then
  echo "Root dir does not exist '$UMBREL_ROOT'"
  exit 1
fi

BITCOIN_NETWORK="mainnet"
[[ -f "${UMBREL_ROOT}/.env" ]] && source "${UMBREL_ROOT}/.env"

# Monitor LND channel.backup
monitor_path "${UMBREL_ROOT}/lnd/data/chain/bitcoin/${BITCOIN_NETWORK}/channel.backup"

# Monitor db/user.json
monitor_path "${UMBREL_ROOT}/db/user.json"

done
