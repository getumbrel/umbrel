#!/usr/bin/env bash

# function to upload the output to our paste server
# Based on https://github.com/seejohnrun/haste-client#lightweight-alternative
upload() { a=$(cat); curl -X POST -s -d "$a" https://umbrel-paste.vercel.app/documents | awk -F '"' '{print "https://umbrel-paste.vercel.app/"$6}'; }

UMBREL_ROOT="$(readlink -f $(dirname "${BASH_SOURCE[0]}")/../..)"
DEBUG_SCRIPT="${UMBREL_ROOT}/scripts/debug"

cat <<EOF > "$UMBREL_ROOT"/statuses/debug-result.json
{"status": "processing", "linkDebug": "", "linkDmesg": "", "output": ""}
EOF

debug_result=$(${DEBUG_SCRIPT} | sed '/onion/d')

dmesglink=$(dmesg | upload)
debuglink=$(echo "$debug_result" | upload)
result64=$(echo "$debug_result" | base64 | tr -d '\n')

cat <<EOF > "$UMBREL_ROOT"/statuses/debug-result.json
{"status": "success", "linkDebug": "${debuglink}", "linkDmesg": "${dmesglink}", "output": "${result64}"}
EOF

echo "Debug result file generated"