#!/usr/bin/env bash

# function to upload the output to our paste server
# Based on https://github.com/seejohnrun/haste-client#lightweight-alternative
upload() {
  curl \
    --header "Content-Type: text/plain" \
    --request POST \
    --silent \
    --data-binary @- \
    https://debug.umbrel.tech/documents \
    | awk -F '"' '{print "https://debug.umbrel.tech/"$6}'
}

UMBREL_ROOT="$(readlink -f $(dirname "${BASH_SOURCE[0]}")/../..)"
DEBUG_SCRIPT="${UMBREL_ROOT}/scripts/debug"

cat <<EOF > "$UMBREL_ROOT"/statuses/debug-result.json
{"status": "processing", "linkDebug": "", "linkDmesg": "", "output": ""}
EOF

debug_result=$(${DEBUG_SCRIPT} | sed '/onion/d')

debug_link=$(echo "${debug_result} === Umbrel-Paste split === $(dmesg)" | upload)
result64=$(echo "${debug_result}" | base64 | tr -d '\n')

cat <<EOF > "$UMBREL_ROOT"/statuses/debug-result.json
{"status": "success", "linkDebug": "${debug_link}", "output": "${result64}"}
EOF

echo "Debug result file generated"